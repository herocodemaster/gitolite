From: Jiang Xin <jiangxin@ossxp.com>
Subject: [PATCH] t/creator_is_admin

Creator has full rights.

Signed-off-by: Jiang Xin <jiangxin@ossxp.com>

---
 hooks/common/update |   19 ++++++++++++++++---
 src/gitolite.pm     |    7 ++++++-
 2 个文件被修改，插入 22 行(+)，删除 4 行(-)

diff --git a/hooks/common/update b/hooks/common/update
index f31f108..0f193c5 100755
--- a/hooks/common/update
+++ b/hooks/common/update
@@ -75,9 +75,22 @@ push @allowed_refs, @ { $repos{'@all'}       {$ENV{GL_USER}} || [] };
 push @allowed_refs, @ { $repos{$ENV{GL_REPO}}{'@all'} || [] };
 push @allowed_refs, @ { $repos{'@all'}       {'@all'} || [] };
 
-# first check the main ref (this is a *real* ref, like refs/heads/master, and
-# is what we print in the log)
-my $log_refex = check_ref(\@allowed_refs, $ENV{GL_REPO}, $ref, $att_acc);
+my $log_refex = '';
+
+# we potentially have many "refs" to check.  The one we print in the log is
+# the *first* one (which is a *real* ref, like refs/heads/master), while all
+# the rest (if they exist) are like NAME/something.  So we do the first one
+# separately to capture it, then run the rest (if any)
+my ($creatorid, %dummy) = wild_repo_rights($ENV{GL_REPO}, "");
+
+# bypass auth check of *real* ref if user is creater.
+# As when do check_ref, if no permission, exist (die) directly.
+if ($ENV{GL_USER} ne $creatorid and $creatorid ne "")
+{
+    # first check the main ref (this is a *real* ref, like refs/heads/master, and
+    # is what we print in the log)
+    $log_refex = check_ref(\@allowed_refs, $ENV{GL_REPO}, $ref, $att_acc);
+}
 
 # then we check all virtual refs
 check_vrefs(\@allowed_refs, $ENV{GL_REPO}, $att_acc);
diff --git a/src/gitolite.pm b/src/gitolite.pm
index fbae91d..702f4bc 100644
--- a/src/gitolite.pm
+++ b/src/gitolite.pm
@@ -27,6 +27,7 @@ use Exporter 'import';
     slurp
     special_cmd
     try_adc
+    wild_repo_rights
     wrap_mkdir
     wrap_chdir
     wrap_open
@@ -838,6 +839,9 @@ sub add_repo_conf
         }
 
         if ($exists) {
+            if ($creator and $creator eq $ENV{GL_USER}) {
+                $perm = ' %R %W';
+            }
             if ($creator and $wild) {
                 $creator = "($creator)";
             } elsif ($creator and not $wild) {
@@ -849,7 +853,8 @@ sub add_repo_conf
             }
         } else {
             # repo didn't exist; C perms need to be filled in
-            $perm = ( $repos{$repo}{C}{'@all'} ? ' @C' : ( $repos{$repo}{C}{$ENV{GL_USER}} ? ' =C' : '   ' )) if $GL_WILDREPOS;
+            # PUSH to create needs user has both C and RW rights.
+            $perm = ( $repos{$repo}{C}{'@all'} ? ' @C  @R  @W' : ( $repos{$repo}{C}{$ENV{GL_USER}} ? ' =C  %R  %W' : '   ' )) if $GL_WILDREPOS;
             # if you didn't have perms to create it, delete the "convenience"
             # copy of the ACL that parse_acl makes
             delete $repos{$repo} if $perm !~ /C/ and $wild;
-- 
tg: (d59bc35..) t/creator_is_admin (depends on: upstream)
