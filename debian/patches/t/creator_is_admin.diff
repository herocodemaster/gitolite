From: Jiang Xin <jiangxin@ossxp.com>
Subject: [PATCH] t/creator_is_admin

Creator has full rights.

Signed-off-by: Jiang Xin <jiangxin@ossxp.com>

---
 hooks/common/update |   12 ++++++++++--
 src/gitolite.pm     |    7 ++++++-
 2 个文件被修改，插入 16 行(+)，删除 3 行(-)

diff --git a/hooks/common/update b/hooks/common/update
index 1048208..0677bbd 100755
--- a/hooks/common/update
+++ b/hooks/common/update
@@ -99,8 +99,16 @@ if (exists $repos{$ENV{GL_REPO}}{NAME_LIMITS}) {
 # the *first* one (which is a *real* ref, like refs/heads/master), while all
 # the rest (if they exist) are like NAME/something.  So we do the first one
 # separately to capture it, then run the rest (if any)
-my $log_refex = check_ref(\@allowed_refs, $ENV{GL_REPO}, (shift @refs), $att_acc);
-check_ref                (\@allowed_refs, $ENV{GL_REPO}, $_           , $att_acc) for @refs;
+my ($creatorid, $dummy, $dummy2) = wild_repo_rights($ENV{GL_REPO}, "");
+my $log_refex = '';
+
+# bypass check if user is creater. As when do check_ref, if no permission,
+# exist (die) directly.
+if ($ENV{GL_USER} ne $creatorid)
+{
+    $log_refex = check_ref(\@allowed_refs, $ENV{GL_REPO}, (shift @refs), $att_acc);
+    check_ref                (\@allowed_refs, $ENV{GL_REPO}, $_           , $att_acc) for @refs;
+}
 
 # if we returned at all, all the checks succeeded.  Check secondary hooks now
 $UPDATE_CHAINS_TO ||= 'hooks/update.secondary';
diff --git a/src/gitolite.pm b/src/gitolite.pm
index 062706f..9172a7f 100644
--- a/src/gitolite.pm
+++ b/src/gitolite.pm
@@ -27,6 +27,7 @@ use Exporter 'import';
     slurp
     special_cmd
     try_adc
+    wild_repo_rights
     wrap_chdir
     wrap_open
     wrap_print
@@ -810,6 +811,9 @@ sub add_repo_conf
         }
 
         if ($exists) {
+            if ($creator and $creator eq $ENV{GL_USER}) {
+                $perm = ' %R %W';
+            }
             if ($creator and $wild) {
                 $creator = "($creator)";
             } elsif ($creator and not $wild) {
@@ -821,7 +825,8 @@ sub add_repo_conf
             }
         } else {
             # repo didn't exist; C perms need to be filled in
-            $perm = ( $repos{$repo}{C}{'@all'} ? ' @C' : ( $repos{$repo}{C}{$ENV{GL_USER}} ? ' =C' : '   ' )) if $GL_WILDREPOS;
+            # PUSH to create needs user has both C and RW rights.
+            $perm = ( $repos{$repo}{C}{'@all'} ? ' @C  @R  @W' : ( $repos{$repo}{C}{$ENV{GL_USER}} ? ' =C  %R  %W' : '   ' )) if $GL_WILDREPOS;
             # if you didn't have perms to create it, delete the "convenience"
             # copy of the ACL that parse_acl makes
             delete $repos{$repo} if $perm !~ /C/ and $wild;
-- 
tg: (01e789a..) t/creator_is_admin (depends on: upstream)
