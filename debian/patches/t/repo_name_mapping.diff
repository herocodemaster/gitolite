From: Jiang Xin <jiangxin@ossxp.com>
Subject: [PATCH] t/repo_name_mapping

<patch description>

Signed-off-by: Jiang Xin <jiangxin@ossxp.com>

---
 src/gitolite.pm     |   21 +++++++++++++++++++++
 src/gl-auth-command |    3 +++
 src/gl-compile-conf |   15 ++++++++++++++-
 3 个文件被修改，插入 38 行(+)，删除 1 行(-)

diff --git a/src/gitolite.pm b/src/gitolite.pm
index fbae91d..80332fa 100644
--- a/src/gitolite.pm
+++ b/src/gitolite.pm
@@ -14,6 +14,7 @@ use Exporter 'import';
     list_phy_repos
     ln_sf
     log_it
+    map_repo
     new_repo
     new_wild_repo
     repo_rights
@@ -89,6 +90,7 @@ $GITWEB_URI_ESCAPE &&= eval "use CGI::Util qw(escape); 1";
 
 our %repos;
 our %groups;
+our %mapping;
 our %git_configs;
 our %split_conf;
 our $data_version;
@@ -696,6 +698,25 @@ sub expand_wild
 }
 
 # ----------------------------------------------------------------------------
+#       map repo from A to B
+# ----------------------------------------------------------------------------
+
+sub map_repo
+{
+    my ($GL_CONF_COMPILED, $repo) = @_;
+    die "parse $GL_CONF_COMPILED failed: " . ($! or $@) unless do $GL_CONF_COMPILED;
+
+    for my $m (sort keys %mapping) {
+        if ($repo =~ /^$m$/) {
+            $repo =~ s/$m/$mapping{$m}->()/e;
+            last
+        }
+    }
+
+    return $repo;
+}
+
+# ----------------------------------------------------------------------------
 #       parse the compiled acl
 # ----------------------------------------------------------------------------
 
diff --git a/src/gl-auth-command b/src/gl-auth-command
index 851f614..6569de6 100755
--- a/src/gl-auth-command
+++ b/src/gl-auth-command
@@ -131,6 +131,9 @@ unless ( $verb and ( $verb eq 'git-init' or $verb =~ $R_COMMANDS or $verb =~ $W_
 die "$repo ends with a slash; I don't like that\n" if $repo =~ /\/$/;
 die "$repo has two consecutive periods; I don't like that\n" if $repo =~ /\.\./;
 
+# map repo from A to B
+$repo = map_repo($GL_CONF_COMPILED, $repo);
+
 # save the reponame; too many things need this
 $ENV{GL_REPO}=$repo;
 
diff --git a/src/gl-compile-conf b/src/gl-compile-conf
index f497ae5..51c4cca 100755
--- a/src/gl-compile-conf
+++ b/src/gl-compile-conf
@@ -34,6 +34,9 @@ open STDOUT, ">", "/dev/null" if (@ARGV and shift eq '-q');
 # group is defined).
 # our %groups = ();     # moved to gitolite.pm now
 
+# map repo from A to B
+our %mapping = ();
+
 # %repos has two functions.
 
 # $repos{repo}{R|W}{user} = 1 if user has R (or W) permissions for at least
@@ -145,6 +148,13 @@ sub parse_conf_line
         $groups{$1} = {} unless $groups{$1};
         die "$ABRT bad group '$1'\n" unless $1 =~ $REPONAME_PATT;
     }
+    # mapping repo from A to B.
+    # B should not start with double quote, or conflict with latter regex of gitweb description.
+    elsif ($line =~ /^map (.*\S)\s*=\s*([^"].*?)$/)
+    {
+        # store each mapping as hash.
+        $mapping{$1} = "sub { \"$2\" }";
+    }
     # repo(s)
     elsif ($line =~ /^repo (.*)/)
     {
@@ -491,7 +501,10 @@ sub write_compiled_conf
     my $compiled_fh = wrap_open( ">", "$GL_CONF_COMPILED.new" );
     my $data_version = $current_data_version;
     print $compiled_fh Data::Dumper->Dump([$data_version], [qw(*data_version)]);
-    my $dumped_data = Data::Dumper->Dump([\%repos], [qw(*repos)]);
+    my $dumped_data = Data::Dumper->Dump([\%mapping], [qw(*mapping)]);
+    $dumped_data =~ s/'(sub {.*})'/$1/g;
+    print $compiled_fh $dumped_data;
+    $dumped_data = Data::Dumper->Dump([\%repos], [qw(*repos)]);
     $dumped_data .= Data::Dumper->Dump([\%git_configs], [qw(*git_configs)]) if %git_configs;
     # the dump uses single quotes, but we convert any strings containing $creator
     # and $gl_user to double quoted strings.  A bit sneaky, but not too much...
-- 
tg: (d59bc35..) t/repo_name_mapping (depends on: upstream)
