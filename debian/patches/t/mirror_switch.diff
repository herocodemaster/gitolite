From: Jiang Xin <jiangxin@ossxp.com>
Subject: [PATCH] t/mirror_switch

Do not mirror repository if set gitolite.mirror to false.

Signed-off-by: Jiang Xin <jiangxin@ossxp.com>

---
 hooks/common/post-receive.mirrorpush |   15 ++++++++++++++-
 src/gl-mirror-sync                   |   10 ++++++++++
 2 files changed, 24 insertions(+), 1 deletions(-)

diff --git a/hooks/common/post-receive.mirrorpush b/hooks/common/post-receive.mirrorpush
index 6be6d81..32b7400 100755
--- a/hooks/common/post-receive.mirrorpush
+++ b/hooks/common/post-receive.mirrorpush
@@ -10,6 +10,13 @@
 
 if [ -n "$GL_SLAVES" ]
 then
+    if [ "$(git config --bool gitolite.mirror)" = "false" ]
+    then
+        echo "**************************************************" >&2
+        echo "WARNING: mirror disabled for this repository."      >&2
+        echo "**************************************************" >&2
+        exit 0
+    fi
     for mirror in $GL_SLAVES
     do
         if git push --mirror $mirror:$GL_REPO.git
@@ -19,8 +26,14 @@ then
             ssh $mirror mkdir -p $GL_REPO.git
             ssh $mirror git init --bare $GL_REPO.git
             ssh $mirror "cd $GL_REPO.git; git config receive.fsckObjects true"
-            git push --mirror $mirror:$GL_REPO.git ||
+            if git push --mirror $mirror:$GL_REPO.git
+            then
+                :
+            else
+                echo "**************************************************"
                 echo "WARNING: mirror push to $mirror failed"
+                echo "**************************************************"
+            fi
         fi
     done
 fi >&2
diff --git a/src/gl-mirror-sync b/src/gl-mirror-sync
index e946ec0..5bc2134 100755
--- a/src/gl-mirror-sync
+++ b/src/gl-mirror-sync
@@ -25,6 +25,15 @@ do
         continue
     fi
 
+    # mirror can be disabled by gitolite.mirror config variable
+    if [ "$(git config --bool gitolite.mirror)" = "false" ]
+    then
+        echo "**************************************************" >&2
+        echo "WARNING: mirror disabled for repository $r."        >&2
+        echo "**************************************************" >&2
+        continue
+    fi
+
     # this is essentially the same code as in the post-receive hook
     if git push --mirror $mirror:$r
     then
@@ -32,6 +41,7 @@ do
     else
         ssh $mirror mkdir -p $r
         ssh $mirror git init --bare $r
+        ssh $mirror "cd $r; git config receive.fsckObjects true"
         git push --mirror $mirror:$r ||
             echo "WARNING: mirror push to $mirror failed"
     fi < /dev/null
-- 
tg: (59f3c4a..) t/mirror_switch (depends on: upstream)
